name: Deploy paymonth-nextjs on self-hosted server

on:
  push:
    branches:
      - main        # ถ้า deploy จาก branch อื่น เปลี่ยนตามจริง

jobs:
  deploy:
    runs-on: self-hosted    # ใช้ runner ที่อยู่บน server เครื่องนี้

    steps:
      - name: Go to project folder
        run: |
          cd /home/phoubon-test-paymonth/htdocs/test-paymonth.phoubon.in.th
          pwd
          ls

      - name: Git pull latest code
        run: |
          cd /home/phoubon-test-paymonth/htdocs/test-paymonth.phoubon.in.th
          git pull origin main

      - name: Install dependencies
        run: |
          cd /home/phoubon-test-paymonth/htdocs/test-paymonth.phoubon.in.th
          npm install

      - name: Prisma generate
        run: |
          cd /home/phoubon-test-paymonth/htdocs/test-paymonth.phoubon.in.th
          npx prisma generate

      - name: Build Next.js
        run: |
          cd /home/phoubon-test-paymonth/htdocs/test-paymonth.phoubon.in.th
          npm run build

      - name: Restart app with PM2
        run: |
          cd /home/phoubon-test-paymonth/htdocs/test-paymonth.phoubon.in.th
          pm2 del 0 
          pm2 start "npm start" --name paymonth-nextjs || pm2 reload paymonth-nextjs
          pm2 save
